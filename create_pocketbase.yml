---
- name: Build and run pocketBase docker container
  hosts: all
  connection: local
  tasks:
    - name: Ensure App Directories Exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "/deploypocket/pocketbase"
        - "/deploypocket/apps/{{ instance_code }}/pb/migrations"
        - "/deploypocket/apps/{{ instance_code }}/pb/pb_data"
        - "/deploypocket/apps/{{ instance_code }}/pb/pb_hooks"
        - "/deploypocket/apps/{{ instance_code }}/pb/storage"

    - name: Create hooks file
      file:
        path: "/deploypocket/apps/{{ instance_code }}/pb/pb_hooks/main.pb.js"
        state: touch
        
    - name: Write Dockerfile for PocketBase
      copy:
        dest: "/deploypocket/pocketbase/Dockerfile"
        content: |
          FROM alpine:latest
          ARG PB_VERSION=0.22.19
          
          RUN apk add --no-cache \
              unzip \
              ca-certificates
          # download and unzip PocketBase
          ADD https://github.com/pocketbase/pocketbase/releases/download/v${PB_VERSION}/pocketbase_${PB_VERSION}_linux_amd64.zip /tmp/pb.zip
          RUN unzip /tmp/pb.zip -d /pb/
          # start PocketBase
          CMD ["/pb/pocketbase", "serve", "--http=0.0.0.0:8090"]
          
    - name: Build pocketBase docker image
      docker_image:
        name: "pocketbase-003-{{ pb_version }}"
        source: build
        build:
          path: /deploypocket/pocketbase/
          dockerfile: /deploypocket/pocketbase/Dockerfile
          args:
            PB_VERSION: "{{ pb_version }}"
        state: present
        force_tag: true


    - name: Run pocketBase docker container
      docker_container:
        name: "{{ instance_code }}"
        image: "pocketbase-003-{{ pb_version }}:latest"
        state: started
        restart_policy: always
        cpus: "{{ v_cpu }}"
        memory: "{{ v_ram }}M"
        networks:
          - name: caddy_network
        volumes:
          - "/deploypocket/apps/{{ instance_code }}/pb/migrations:/pb/migrations"
          - "/deploypocket/apps/{{ instance_code }}/pb/pb_data:/pb/pb_data"
          - "/deploypocket/apps/{{ instance_code }}/pb/pb_hooks:/pb/pb_hooks"
          - "/deploypocket/apps/{{ instance_code }}/pb/storage:/pb/storage"
        labels:
          "sablier.enable": "true"        

    - name: Run pocketbase migrations
      community.docker.docker_container_exec:
        container: "{{ instance_code }}"
        argv:
          - /pb/pocketbase
          - "migrate"
          - "up"

    - name: Create admin account
      community.docker.docker_container_exec:
        container: "{{ instance_code }}"
        argv:
          - /pb/pocketbase
          - "admin"
          - "create"
          - "{{ admin_email }}"
          - "{{ admin_password }}"

    - name: Add caddy and sablier config
      ansible.builtin.copy:
        content: |
          http://{{ instance_code }}.deploypocket.com {
            route /* {
              sablier {
                names {{ instance_code }}
                session_duration 1m
                blocking
              }
              reverse_proxy {{ instance_code }}:8090
            }
          }
          
        dest: /deploypocket/apps/{{ instance_code }}/caddy+sablier.conf
        mode: '0644'

    - name: Reload caddy configuration
      include_tasks: "reload_caddy_configuration.yml"